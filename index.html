<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RealFirmware ‚Äî File Explorer</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2358a6ff'><path d='M3 3h8l2 2h8a1 1 0 011 1v13a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1z'/></svg>">
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d1117;--surface:#161b22;--border:#30363d;--text:#e6edf3;--text2:#8b949e;
  --accent:#58a6ff;--accent2:#3fb950;--hover:rgba(56,139,253,.1);--card:#21262d;
  --red:#f85149;--orange:#f0883e;--purple:#bc8cff;--yellow:#d29922;
  --radius:8px;--transition:.15s ease
}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
::selection{background:var(--accent);color:#fff}
::-webkit-scrollbar{width:8px;height:8px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header{background:var(--surface);border-bottom:1px solid var(--border);padding:14px 24px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;position:sticky;top:0;z-index:100}
.logo{font-size:20px;font-weight:700;display:flex;align-items:center;gap:8px;white-space:nowrap}
.logo svg{width:26px;height:26px;fill:var(--accent)}
.header-stats{margin-left:auto;color:var(--text2);font-size:13px;display:flex;gap:18px}
.header-stats span{display:flex;align-items:center;gap:5px}

/* ‚îÄ‚îÄ Breadcrumb ‚îÄ‚îÄ */
.breadcrumb{padding:10px 24px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:4px;flex-wrap:wrap;font-size:14px}
.breadcrumb a,.breadcrumb button{padding:3px 8px;border-radius:6px;transition:background var(--transition);background:none;border:none;color:var(--accent);cursor:pointer;font:inherit}
.breadcrumb a:hover,.breadcrumb button:hover{background:var(--hover);text-decoration:none}
.breadcrumb .sep{color:var(--text2);font-size:11px;margin:0 1px}
.breadcrumb .current{color:var(--text);font-weight:600;padding:3px 8px}

/* ‚îÄ‚îÄ Toolbar ‚îÄ‚îÄ */
.container{max-width:1280px;margin:0 auto;padding:0 16px 60px}
.toolbar{padding:14px 0;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.search-wrap{flex:1;min-width:220px;max-width:480px;position:relative}
.search-wrap input{width:100%;padding:9px 14px 9px 38px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:14px;outline:none;transition:border-color var(--transition)}
.search-wrap input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(56,139,253,.15)}
.search-wrap svg{position:absolute;left:11px;top:50%;transform:translateY(-50%);width:16px;height:16px;fill:var(--text2)}
.search-wrap .clear-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);cursor:pointer;font-size:18px;line-height:1;padding:2px 4px;display:none}
.search-wrap .clear-btn.show{display:block}

.btn{padding:8px 14px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:background var(--transition),border-color var(--transition);font-weight:500;white-space:nowrap}
.btn:hover{background:var(--hover);border-color:var(--text2)}
.btn svg{width:16px;height:16px;fill:currentColor}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-primary{background:#238636;border-color:#238636;color:#fff}
.btn-primary:hover{background:#2ea043}
.btn-accent{background:var(--accent);border-color:var(--accent);color:#fff}
.btn-accent:hover{background:#4493f8}
.btn-ghost{border-color:transparent;background:transparent}

/* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
.filters{padding:0 0 10px;display:none;gap:10px;flex-wrap:wrap}
.filters.show{display:flex}
.filter-group{display:flex;flex-direction:column;gap:4px}
.filter-group label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.filter-group select{padding:7px 30px 7px 10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-size:13px;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b949e' viewBox='0 0 16 16'%3E%3Cpath d='M4.427 7.427l3.396 3.396a.25.25 0 00.354 0l3.396-3.396A.25.25 0 0011.396 7H4.604a.25.25 0 00-.177.427z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;cursor:pointer;min-width:140px}
.filter-group select:focus{border-color:var(--accent)}
.active-filters{display:flex;gap:6px;flex-wrap:wrap;align-items:center;padding-bottom:8px}
.active-filters:empty{display:none}
.filter-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:12px;background:rgba(56,139,253,.15);color:var(--accent);border:1px solid rgba(56,139,253,.3)}
.filter-tag button{background:none;border:none;color:var(--accent);cursor:pointer;font-size:14px;line-height:1;padding:0 0 0 2px}

/* ‚îÄ‚îÄ Info panel ‚îÄ‚îÄ */
.info-panel{padding:18px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:12px}
.info-panel h3{font-size:15px;margin-bottom:10px;display:flex;align-items:center;gap:8px;color:var(--text2)}
.info-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
.info-item{padding:10px 12px;background:var(--card);border-radius:6px;border:1px solid var(--border)}
.info-item .label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.info-item .value{font-size:16px;font-weight:700}

/* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
.file-table{width:100%;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.file-table table{width:100%;border-collapse:collapse}
.file-table th{text-align:left;padding:10px 14px;background:var(--surface);border-bottom:1px solid var(--border);font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;cursor:pointer;user-select:none;white-space:nowrap;transition:color var(--transition)}
.file-table th:hover{color:var(--text)}
.file-table th.active{color:var(--accent)}
.file-table th .arrow{margin-left:4px;font-size:10px}
.file-table td{padding:7px 14px;border-bottom:1px solid var(--border);font-size:14px;vertical-align:middle}
.file-table tr:last-child td{border-bottom:none}
.file-table tbody tr{transition:background .08s}
.file-table tbody tr:hover{background:var(--hover)}

.fname{display:flex;align-items:center;gap:9px}
.fname svg{width:20px;height:20px;flex-shrink:0}
.ic-dir{fill:var(--accent)}.ic-fw{fill:var(--orange)}.ic-doc{fill:var(--accent2)}.ic-img{fill:var(--purple)}.ic-exe{fill:var(--red)}.ic-cfg{fill:var(--yellow)}.ic-file{fill:var(--text2)}.ic-vid{fill:var(--red)}
.fname a,.fname button{font-weight:500;background:none;border:none;color:var(--accent);cursor:pointer;font:inherit;text-align:left}
.fsize{color:var(--text2);white-space:nowrap;font-variant-numeric:tabular-nums}
.ftype{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;border:1px solid var(--border);color:var(--text2);background:var(--card)}

.actions-cell{display:flex;gap:4px;align-items:center}
.link-btn{position:relative}
.link-btn .tooltip{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg);font-size:11px;padding:3px 8px;border-radius:4px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s}
.link-btn .tooltip.show{opacity:1}

.empty-state{padding:60px 20px;text-align:center;color:var(--text2)}
.empty-state svg{width:48px;height:48px;fill:var(--border);margin-bottom:12px}
.empty-state p{font-size:16px;margin-bottom:6px}
.empty-state small{font-size:13px}

/* ‚îÄ‚îÄ Search results mode ‚îÄ‚îÄ */
.search-result-path{font-size:12px;color:var(--text2);margin-top:2px}
.search-result-path mark{background:rgba(56,139,253,.25);color:var(--accent);padding:0 2px;border-radius:2px}

/* ‚îÄ‚îÄ Progress overlay ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;align-items:center;justify-content:center}
.overlay.show{display:flex}
.overlay-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px 32px;text-align:center;min-width:320px}
.overlay-box p{margin-bottom:14px;font-size:14px}
.pbar{width:100%;height:6px;background:var(--card);border-radius:3px;overflow:hidden}
.pbar-fill{height:100%;background:var(--accent2);border-radius:3px;transition:width .2s;width:0}
.pbar-pct{margin-top:6px;font-size:12px;color:var(--text2)}

.footer{text-align:center;padding:24px;color:var(--text2);font-size:12px;border-top:1px solid var(--border);margin-top:40px}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media(max-width:768px){
  .header{padding:10px 14px}.breadcrumb{padding:8px 14px}
  .file-table td,.file-table th{padding:7px 8px;font-size:13px}
  .col-type,.col-mod,.col-cat{display:none}
  .header-stats{margin-left:0;width:100%;margin-top:4px}
  .info-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
  .search-wrap{max-width:100%}
}
@media(max-width:480px){
  .col-size{display:none}
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="logo">
    <svg viewBox="0 0 24 24"><path d="M3 3h8l2 2h8a1 1 0 011 1v13a1 1 0 01-1 1H3a1 1 0 01-1-1V4a1 1 0 011-1z"/></svg>
    RealFirmware
  </div>
  <div class="header-stats">
    <span id="s-files"><svg viewBox="0 0 16 16" width="14" height="14"><path fill="currentColor" d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0113.25 16h-9.5A1.75 1.75 0 012 14.25z"/></svg> <span>‚Äì</span></span>
    <span id="s-size"><svg viewBox="0 0 16 16" width="14" height="14"><path fill="currentColor" d="M8 0a8 8 0 110 16A8 8 0 018 0z"/></svg> <span>‚Äì</span></span>
  </div>
</div>

<!-- Breadcrumb -->
<div class="breadcrumb" id="breadcrumb"></div>

<div class="container">

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="search-wrap">
      <svg viewBox="0 0 16 16"><path d="M11.5 7a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zm-.82 4.74a6 6 0 111.06-1.06l3.04 3.04a.75.75 0 11-1.06 1.06l-3.04-3.04z"/></svg>
      <input type="text" id="searchInput" placeholder="Search all files‚Ä¶ (name, device, ISP)" autocomplete="off">
      <button class="clear-btn" id="clearSearch" title="Clear search">√ó</button>
    </div>
    <button class="btn" id="toggleFilters" title="Toggle filters">
      <svg viewBox="0 0 16 16"><path d="M.75 3h14.5a.75.75 0 010 1.5H.75a.75.75 0 010-1.5zm3 4h8.5a.75.75 0 010 1.5h-8.5a.75.75 0 010-1.5zm3 4h2.5a.75.75 0 010 1.5h-2.5a.75.75 0 010-1.5z"/></svg>
      Filters
    </button>
    <button class="btn btn-primary" id="dlZip" title="Download current directory as .zip">
      <svg viewBox="0 0 16 16"><path d="M7.47 10.78a.75.75 0 001.06 0l3.75-3.75a.75.75 0 00-1.06-1.06L8.75 8.44V1.75a.75.75 0 00-1.5 0v6.69L4.78 5.97a.75.75 0 00-1.06 1.06l3.75 3.75zM3.75 13a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5z"/></svg>
      Download .zip
    </button>
  </div>

  <!-- Filter bar -->
  <div class="filters" id="filterBar">
    <div class="filter-group">
      <label>Category</label>
      <select id="fCat"><option value="">All</option></select>
    </div>
    <div class="filter-group">
      <label>Device</label>
      <select id="fDev"><option value="">All</option></select>
    </div>
    <div class="filter-group">
      <label>ISP / Variant</label>
      <select id="fIsp"><option value="">All</option></select>
    </div>
    <div class="filter-group">
      <label>File type</label>
      <select id="fType"><option value="">All</option></select>
    </div>
    <div class="filter-group" style="justify-content:flex-end">
      <label>&nbsp;</label>
      <button class="btn btn-sm" id="clearFilters">Clear all</button>
    </div>
  </div>
  <div class="active-filters" id="activeTags"></div>

  <!-- Info panel -->
  <div class="info-panel" id="infoPanel">
    <h3>üìä Directory summary</h3>
    <div class="info-grid" id="infoGrid"></div>
  </div>

  <!-- File listing -->
  <div class="file-table">
    <table>
      <thead>
        <tr>
          <th data-sort="name" class="active" style="width:40%">Name <span class="arrow">‚ñ≤</span></th>
          <th data-sort="size" class="col-size" style="width:10%">Size <span class="arrow"></span></th>
          <th data-sort="type" class="col-type" style="width:10%">Type <span class="arrow"></span></th>
          <th data-sort="category" class="col-cat" style="width:10%">Category <span class="arrow"></span></th>
          <th data-sort="modified" class="col-mod" style="width:14%">Modified <span class="arrow"></span></th>
          <th style="width:16%">Actions</th>
        </tr>
      </thead>
      <tbody id="fileList"></tbody>
    </table>
  </div>
  <div class="empty-state" id="emptyState" style="display:none">
    <svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9l-7-7z"/></svg>
    <p>No files found</p>
    <small>Try adjusting your search or filters</small>
  </div>
</div>

<!-- Progress overlay -->
<div class="overlay" id="overlay">
  <div class="overlay-box">
    <p id="oText">Preparing‚Ä¶</p>
    <div class="pbar"><div class="pbar-fill" id="oFill"></div></div>
    <div class="pbar-pct" id="oPct">0 %</div>
  </div>
</div>

<div class="footer">RealFirmware File Explorer ¬∑ Powered by GitHub Pages</div>

<script>
(function(){
/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let DATA = null;          // full index
let fuse = null;          // Fuse.js instance
let curPath = '';         // current dir path
let sortKey = 'name';
let sortAsc = true;
let searchMode = false;   // true when search is active

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmt = bytes => {
  if (!bytes) return '0 B';
  const k = 1024, u = ['B','KB','MB','GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + u[i];
};
const ext = n => { const i = n.lastIndexOf('.'); return i > 0 ? n.slice(i+1).toLowerCase() : ''; };

/* Icon helpers */
const ICON_CLASS = {
  bin:'ic-fw',img:'ic-fw',txt:'ic-doc',docx:'ic-doc',log:'ic-doc',
  bat:'ic-exe',sh:'ic-exe',exe:'ic-exe',xml:'ic-cfg',cfg:'ic-cfg',ini:'ic-cfg',
  jpg:'ic-img',jpeg:'ic-img',png:'ic-img',webp:'ic-img',gif:'ic-img',mp4:'ic-vid'
};
const ic = (e,isDir) => isDir ? 'ic-dir' : (ICON_CLASS[e]||'ic-file');
const dirIcon = `<svg viewBox="0 0 24 24" class="ic-dir"><path d="M2 6a2 2 0 012-2h5l2 2h9a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/></svg>`;
const fileIcon = c => `<svg viewBox="0 0 24 24" class="${c}"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/><polyline points="14 2 14 8 20 8" fill="none" stroke="currentColor" stroke-width="1"/></svg>`;
const dlSvg = `<svg viewBox="0 0 16 16"><path d="M7.47 10.78a.75.75 0 001.06 0l3.75-3.75a.75.75 0 00-1.06-1.06L8.75 8.44V1.75a.75.75 0 00-1.5 0v6.69L4.78 5.97a.75.75 0 00-1.06 1.06l3.75 3.75zM3.75 13a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5z"/></svg>`;
const linkSvg = `<svg viewBox="0 0 16 16"><path d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-.025 5.475a.75.75 0 00-1.06 0l-1.25 1.25a2 2 0 11-2.83-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 000-1.06z"/></svg>`;

/* ‚îÄ‚îÄ URL / Hash ‚îÄ‚îÄ */
function stateToHash() {
  const p = new URLSearchParams();
  if (curPath) p.set('p', curPath);
  if ($('#fCat').value) p.set('cat', $('#fCat').value);
  if ($('#fDev').value) p.set('dev', $('#fDev').value);
  if ($('#fIsp').value) p.set('isp', $('#fIsp').value);
  if ($('#fType').value) p.set('type', $('#fType').value);
  if ($('#searchInput').value) p.set('q', $('#searchInput').value);
  if (sortKey !== 'name') p.set('sort', sortKey);
  if (!sortAsc) p.set('dir', 'desc');
  return p.toString();
}
function hashToState() {
  const p = new URLSearchParams(location.hash.slice(1));
  curPath = p.get('p') || '';
  $('#fCat').value = p.get('cat') || '';
  $('#fDev').value = p.get('dev') || '';
  $('#fIsp').value = p.get('isp') || '';
  $('#fType').value = p.get('type') || '';
  $('#searchInput').value = p.get('q') || '';
  sortKey = p.get('sort') || 'name';
  sortAsc = p.get('dir') !== 'desc';
  searchMode = !!$('#searchInput').value;
}
function pushState() {
  const h = stateToHash();
  history.pushState(null, '', '#' + h);
}

/* ‚îÄ‚îÄ Direct file URL ‚îÄ‚îÄ */
function fileUrl(filePath) {
  const base = location.origin + location.pathname.replace(/index\.html$/, '');
  return base + encodeURIComponent(filePath).replace(/%2F/g, '/');
}
function directLink(filePath) {
  const p = new URLSearchParams();
  p.set('p', filePath.substring(0, filePath.lastIndexOf('/')));
  return location.origin + location.pathname + '#' + p.toString();
}

/* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
function populateFilters() {
  const d = DATA;
  const addOpts = (sel, items) => {
    const el = $(sel);
    const cur = el.value;
    while (el.options.length > 1) el.remove(1);
    items.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; el.appendChild(o); });
    el.value = cur || '';
  };
  addOpts('#fCat', d.categories);
  addOpts('#fDev', d.devices);
  addOpts('#fIsp', d.isps);
  addOpts('#fType', d.types);
}

function getFilteredFiles() {
  let files = DATA.files;
  const cat = $('#fCat').value;
  const dev = $('#fDev').value;
  const isp = $('#fIsp').value;
  const type = $('#fType').value;
  if (cat) files = files.filter(f => f.category === cat);
  if (dev) files = files.filter(f => f.device === dev);
  if (isp) files = files.filter(f => f.isp === isp);
  if (type) files = files.filter(f => f.type === type);
  return files;
}

function renderActiveTags() {
  const c = $('#activeTags');
  let html = '';
  const vals = [
    { key: 'fCat', label: 'Category' },
    { key: 'fDev', label: 'Device' },
    { key: 'fIsp', label: 'ISP' },
    { key: 'fType', label: 'Type' }
  ];
  vals.forEach(v => {
    const val = $(`#${v.key}`).value;
    if (val) html += `<span class="filter-tag">${v.label}: ${val}<button data-filter="${v.key}" title="Remove">√ó</button></span>`;
  });
  c.innerHTML = html;
  c.querySelectorAll('button').forEach(b => {
    b.addEventListener('click', () => { $(`#${b.dataset.filter}`).value = ''; pushState(); render(); });
  });
}

/* ‚îÄ‚îÄ Directory entries ‚îÄ‚îÄ */
function getEntries(files, path) {
  const prefix = path ? path + '/' : '';
  const dirs = new Set();
  const direct = [];
  files.forEach(f => {
    if (!f.path.startsWith(prefix)) return;
    const rest = f.path.slice(prefix.length);
    const si = rest.indexOf('/');
    if (si >= 0) dirs.add(rest.slice(0, si));
    else direct.push(f);
  });
  return { dirs: [...dirs].sort(), files: direct };
}

function dirStats(files, path) {
  const prefix = path ? path + '/' : '';
  let count = 0, size = 0;
  files.forEach(f => { if (f.path.startsWith(prefix)) { count++; size += f.size; } });
  return { count, size };
}

/* ‚îÄ‚îÄ Sorting ‚îÄ‚îÄ */
function sortEntries(entries) {
  return entries.sort((a, b) => {
    if (a._parent) return -1;
    if (b._parent) return 1;
    if (a._dir !== b._dir) return a._dir ? -1 : 1;
    let cmp = 0;
    switch (sortKey) {
      case 'name': cmp = a.name.localeCompare(b.name, undefined, {numeric: true}); break;
      case 'size': cmp = (a.size || 0) - (b.size || 0); break;
      case 'type': cmp = (a.ext || '').localeCompare(b.ext || ''); break;
      case 'category': cmp = (a.category || '').localeCompare(b.category || ''); break;
      case 'modified': cmp = (a.modified || '').localeCompare(b.modified || ''); break;
    }
    return sortAsc ? cmp : -cmp;
  });
}

/* ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ */
function renderBreadcrumb() {
  const bc = $('#breadcrumb');
  const parts = curPath ? curPath.split('/') : [];
  let html = `<button data-nav="" title="Root">üè† Root</button>`;
  let acc = '';
  parts.forEach((p, i) => {
    html += '<span class="sep">/</span>';
    acc += (acc ? '/' : '') + p;
    if (i === parts.length - 1) html += `<span class="current">${p}</span>`;
    else html += `<button data-nav="${acc}">${p}</button>`;
  });
  bc.innerHTML = html;
  bc.querySelectorAll('button[data-nav]').forEach(b => {
    b.addEventListener('click', () => nav(b.dataset.nav));
  });
}

function renderInfo(files) {
  const grid = $('#infoGrid');
  const stats = dirStats(files, curPath);
  const { dirs, files: direct } = getEntries(files, curPath);
  // Count types
  const prefix = curPath ? curPath + '/' : '';
  const types = {};
  files.forEach(f => { if (f.path.startsWith(prefix)) { types[f.type] = (types[f.type]||0)+1; } });
  let html = `
    <div class="info-item"><div class="label">Total files</div><div class="value">${stats.count}</div></div>
    <div class="info-item"><div class="label">Total size</div><div class="value">${fmt(stats.size)}</div></div>
    <div class="info-item"><div class="label">Subdirectories</div><div class="value">${dirs.length}</div></div>
    <div class="info-item"><div class="label">Direct files</div><div class="value">${direct.length}</div></div>
  `;
  Object.keys(types).sort().forEach(t => {
    html += `<div class="info-item"><div class="label">${t}s</div><div class="value">${types[t]}</div></div>`;
  });
  grid.innerHTML = html;
  // Header stats
  $('#s-files span:last-child').textContent = stats.count + ' files';
  $('#s-size span:last-child').textContent = fmt(stats.size);
}

function render() {
  const q = $('#searchInput').value.trim();
  searchMode = q.length > 0;
  $('#clearSearch').classList.toggle('show', searchMode);

  // Update sort headers
  $$('.file-table th[data-sort]').forEach(th => {
    const k = th.dataset.sort;
    th.classList.toggle('active', k === sortKey);
    th.querySelector('.arrow').textContent = k === sortKey ? (sortAsc ? '‚ñ≤' : '‚ñº') : '';
  });

  renderBreadcrumb();
  renderActiveTags();

  const filtered = getFilteredFiles();

  if (searchMode) {
    renderSearchResults(q, filtered);
    return;
  }

  renderInfo(filtered);
  $('#infoPanel').style.display = '';

  const { dirs, files } = getEntries(filtered, curPath);
  const rows = [];
  if (curPath) rows.push({ _parent: true, _dir: true, name: '..', path: curPath.slice(0, curPath.lastIndexOf('/')) });
  dirs.forEach(d => {
    const dp = (curPath ? curPath + '/' : '') + d;
    const s = dirStats(filtered, dp);
    rows.push({ _dir: true, name: d, path: dp, size: s.size, count: s.count });
  });
  files.forEach(f => rows.push({ ...f, _dir: false }));

  const sorted = sortEntries(rows);
  renderTable(sorted, false);
}

function renderSearchResults(q, files) {
  $('#infoPanel').style.display = 'none';
  // Use Fuse.js
  const results = fuse.search(q, { limit: 100 });
  const matchedFiles = results.map(r => r.item).filter(f => files.includes(f));

  const rows = matchedFiles.map(f => ({ ...f, _dir: false, _searchPath: f.path }));
  renderTable(rows, true);
}

function renderTable(rows, isSearch) {
  const tbody = $('#fileList');
  const empty = $('#emptyState');

  if (rows.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = '';
    return;
  }
  empty.style.display = 'none';

  let html = '';
  rows.forEach(r => {
    if (r._dir) {
      // Directory row
      const label = r._parent ? '‚¨Ü Parent directory' : r.name;
      html += `<tr>
        <td><div class="fname">${dirIcon}<button data-nav="${r.path}">${label}</button></div></td>
        <td class="fsize col-size">${r._parent ? '' : (r.count + ' files ¬∑ ' + fmt(r.size))}</td>
        <td class="col-type">${r._parent ? '' : '<span class="ftype">Folder</span>'}</td>
        <td class="col-cat"></td>
        <td class="col-mod">‚Äî</td>
        <td>${r._parent ? '' : '<div class="actions-cell"><button class="btn btn-sm btn-ghost zip-dir" data-path="'+r.path+'" title="Download as .zip">'+dlSvg+'</button></div>'}</td>
      </tr>`;
    } else {
      // File row
      const e = ext(r.name);
      const url = fileUrl(r.path);
      const modDate = r.modified ? new Date(r.modified).toLocaleDateString('es', {year:'numeric',month:'short',day:'numeric'}) : '‚Äî';
      html += `<tr>
        <td>
          <div class="fname">${fileIcon(ic(e,false))}<a href="${url}" target="_blank" title="${r.path}">${r.name}</a></div>
          ${isSearch ? '<div class="search-result-path">' + r.path + '</div>' : ''}
        </td>
        <td class="fsize col-size">${fmt(r.size)}</td>
        <td class="col-type"><span class="ftype">${r.type || e || '‚Äî'}</span></td>
        <td class="col-cat">${r.category || '‚Äî'}</td>
        <td class="col-mod">${modDate}</td>
        <td>
          <div class="actions-cell">
            <a class="btn btn-sm btn-ghost" href="${url}" download="${r.name}" title="Download">${dlSvg}</a>
            <button class="btn btn-sm btn-ghost link-btn" data-link="${url}" title="Copy direct link">${linkSvg}<span class="tooltip">Copied!</span></button>
          </div>
        </td>
      </tr>`;
    }
  });
  tbody.innerHTML = html;

  // Navigation listeners
  tbody.querySelectorAll('button[data-nav]').forEach(b => {
    b.addEventListener('click', () => nav(b.dataset.nav));
  });
  // Zip dir buttons
  tbody.querySelectorAll('.zip-dir').forEach(b => {
    b.addEventListener('click', () => downloadDirZip(b.dataset.path));
  });
  // Copy link buttons
  tbody.querySelectorAll('.link-btn').forEach(b => {
    b.addEventListener('click', () => {
      navigator.clipboard.writeText(b.dataset.link).then(() => {
        const tip = b.querySelector('.tooltip');
        tip.classList.add('show');
        setTimeout(() => tip.classList.remove('show'), 1200);
      });
    });
  });
}

/* ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ */
function nav(path) {
  curPath = path || '';
  searchMode = false;
  $('#searchInput').value = '';
  pushState();
  render();
}

/* ‚îÄ‚îÄ Zip download ‚îÄ‚îÄ */
async function downloadDirZip(dirPath) {
  const prefix = dirPath ? dirPath + '/' : '';
  const files = DATA.files.filter(f => f.path.startsWith(prefix));
  if (!files.length) return;

  const ov = $('#overlay'), fill = $('#oFill'), pct = $('#oPct'), txt = $('#oText');
  ov.classList.add('show');
  fill.style.width = '0';

  const zip = new JSZip();
  const base = location.origin + location.pathname.replace(/index\.html$/, '');
  let done = 0;
  const total = files.length;
  const batch = 5;

  for (let i = 0; i < total; i += batch) {
    const chunk = files.slice(i, i + batch);
    await Promise.all(chunk.map(async f => {
      const rel = f.path.slice(prefix.length);
      try {
        const r = await fetch(base + encodeURIComponent(f.path).replace(/%2F/g, '/'));
        if (!r.ok) throw new Error(r.status);
        zip.file(rel, await r.blob());
      } catch(e) { console.warn('Skip', f.path, e); }
      done++;
      const p = Math.round(done/total*100);
      fill.style.width = p + '%';
      pct.textContent = `${p}% (${done}/${total})`;
      txt.textContent = 'Downloading: ' + rel;
    }));
  }

  txt.textContent = 'Compressing‚Ä¶';
  const blob = await zip.generateAsync({type:'blob'}, m => {
    fill.style.width = m.percent.toFixed(0)+'%';
    pct.textContent = 'Compressing: ' + m.percent.toFixed(0) + '%';
  });

  const name = dirPath ? dirPath.split('/').pop() : 'firmware-extracted';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name + '.zip';
  a.click();
  URL.revokeObjectURL(a.href);
  ov.classList.remove('show');
}

/* ‚îÄ‚îÄ Event binding ‚îÄ‚îÄ */
function bindEvents() {
  // Sort
  $$('.file-table th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const k = th.dataset.sort;
      if (sortKey === k) sortAsc = !sortAsc;
      else { sortKey = k; sortAsc = true; }
      pushState();
      render();
    });
  });

  // Search (debounced)
  let timer;
  $('#searchInput').addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(() => { pushState(); render(); }, 200);
  });
  $('#clearSearch').addEventListener('click', () => {
    $('#searchInput').value = '';
    searchMode = false;
    pushState();
    render();
  });

  // Filters
  ['#fCat','#fDev','#fIsp','#fType'].forEach(s => {
    $(s).addEventListener('change', () => { pushState(); render(); });
  });
  $('#toggleFilters').addEventListener('click', () => {
    $('#filterBar').classList.toggle('show');
  });
  $('#clearFilters').addEventListener('click', () => {
    ['#fCat','#fDev','#fIsp','#fType'].forEach(s => $(s).value = '');
    pushState();
    render();
  });

  // Download zip
  $('#dlZip').addEventListener('click', () => downloadDirZip(curPath || 'firmware-extracted'));

  // Back/forward
  window.addEventListener('popstate', () => { hashToState(); render(); });

  // Keyboard shortcut: / to focus search
  document.addEventListener('keydown', e => {
    if (e.key === '/' && document.activeElement !== $('#searchInput')) {
      e.preventDefault();
      $('#searchInput').focus();
    }
    if (e.key === 'Escape') {
      $('#searchInput').blur();
      if (searchMode) { $('#searchInput').value = ''; searchMode = false; pushState(); render(); }
    }
  });
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
async function init() {
  try {
    const r = await fetch('file-index.json');
    DATA = await r.json();
  } catch(e) {
    $('#fileList').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text2)">Failed to load file-index.json</td></tr>';
    return;
  }

  // Init Fuse.js search engine
  fuse = new Fuse(DATA.files, {
    keys: [
      { name: 'name', weight: 3 },
      { name: 'path', weight: 1 },
      { name: 'device', weight: 2 },
      { name: 'isp', weight: 2 },
      { name: 'category', weight: 1 },
      { name: 'type', weight: 1 }
    ],
    threshold: 0.35,
    ignoreLocation: true,
    includeScore: true
  });

  populateFilters();
  hashToState();
  bindEvents();
  render();
}

init();
})();
</script>
</body>
</html>
